---
export const prerender = false;
import Layout from '@layouts/Layout.astro';
import Button from '@components/ui/Button.astro';
import { consumeToken } from '@utils/tokenStore';
const token = Astro.url.searchParams.get('token');

if (!token) return Astro.redirect('/');

const pdf = consumeToken(token);

if (!pdf) return Astro.redirect('/');

const seoTitle = 'Demande envoy√©e | Mon Assistant Formalit√©s';
const seoDescription = 'Votre demande a bien √©t√© transmise. Nous revenons vers vous rapidement par email.';
---

<Layout title={seoTitle} description={seoDescription}>
    <div class="w-full min-h-[80vh] flex items-center bg-gray-50">
        <div class="site-container mx-auto px-4 py-base text-center">
            <div class="max-w-2xl mx-auto bg-white p-10 rounded-3xl shadow-lg">
                <!-- Badge succ√®s -->
                <div class="mb-6 flex justify-center">
                    <div class="w-16 h-16 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-3xl">‚úì</div>
                </div>

                <!-- Titre -->
                <h1 class="mb-4 text-3xl md:text-4xl font-extrabold text-primary" data-aos="fade-up">Merci pour votre confiance</h1>

                <!-- Message principal -->
                <p class="text-lg mb-4" data-aos="fade-up" data-aos-delay="100">Votre demande a bien √©t√© transmise.</p>

                <p class="text-base mb-8" data-aos="fade-up" data-aos-delay="150">Un email de confirmation contenant votre r√©capitulatif PDF vous a √©t√© envoy√©.</p>

                <p class="text-base mb-6 italic font-light" data-aos="fade-up" data-aos-delay="200">Vous pouvez √©galement le t√©l√©charger directement ci-dessous.</p>

                <!-- Bouton t√©l√©chargement -->
                <div class="flex justify-center mb-12" data-aos="fade-up" data-aos-delay="250">
                    <Button id="downloadPdf" variant="primary" size="lg" aria-label="T√©l√©chargez le r√©capitulatif PDF">üìÑ T√©l√©charger le r√©capitulatif PDF</Button>
                </div>

                <!-- Message suppl√©mentaire -->
                <p class="text-sm text-gray-500" data-aos="fade-up" data-aos-delay="300">Si vous ne recevez pas l‚Äôemail dans les prochaines minutes, pensez √† v√©rifier votre dossier spam.</p>

                <!-- Retour ou action secondaire -->
                <div class="mt-8"><Button href="/" variant="primary" size="md">Retour √† l‚Äôaccueil</Button></div>
            </div>
        </div>
    </div>
</Layout>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const button = document.getElementById('downloadPdf');
        const pdfData = sessionStorage.getItem('generatedPdf');

        if (!button || !pdfData) return;

        button.addEventListener('click', () => {
            const link = document.createElement('a');
            link.href = pdfData;
            link.download = 'recapitulatif-demande.pdf';
            link.click();
        });

        sessionStorage.removeItem('generatedPdf');
    });
</script>

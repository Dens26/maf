---
import Button from '@components/ui/Button.astro';
import Input from '@components/ui/form/Input.astro';
import Radio from '@components/ui/form/Radio.astro';
import Select from '@components/ui/form/Select.astro';
import Textarea from '@components/ui/form/Textarea.astro';
import countries from '@data/countries.json';

const existingsirenOptions = [
    { label: 'Oui', value: 'oui' },
    { label: 'Non', value: 'non' },
];

const microOptions = [
    { label: 'Oui', value: 'oui' },
    { label: 'Non', value: 'non' },
];

const accreOptions = [
    { label: 'Oui', value: 'oui' },
    { label: 'Non', value: 'non' },
];

const supportcontractOptions = [
    { label: 'Oui', value: 'oui' },
    { label: 'Non', value: 'non' },
];

const turnoverOptions = [
    { label: 'Mensuel', value: 'mensuel' },
    { label: 'Trimestriel', value: 'trimestriel' },
];

const otheractivityOptions = [
    { label: 'Sans activité', value: 'Sans activité' },
    { label: 'Non salarié non agricole', value: 'Non salarié non agricole' },
    { label: 'Pension d\'invalidité', value: 'Invalidité' },
    { label: 'Retraité', value: 'Retraité' },
    { label: 'Salarié', value: 'Salarié' },
    { label: 'Salarié agricole', value: 'Salarié agricole' },
    { label: 'Autre', value: 'Autre' },
];

const domiciliationOptions = [
    { label: 'au domicile personnel', value: 'personnel' },
    { label: 'dans un local professionnel', value: 'local' },
    { label: 'à l’adresse du bien loué (LMNP)', value: 'lmnp' },
    { label: 'dans un centre de domiciliation', value: 'domiciliation' }
];

const formofactivityOptions = [
    { label: 'libérale', value: 'liberale' },
    { label: 'commerciale', value: 'commerciale' },
    { label: 'artisanale', value: 'artisanale' },
    { label: 'location de biens immobiliers', value: 'location_biens' },
    { label: 'agricole', value: 'agricole' }
];

const complementnumberOptions = [
    { label: 'Bis', value: 'bis' },
    { label: 'Ter', value: 'ter' },
    { label: 'Quater', value: 'quater' },
    { label: 'Quinquies', value: 'quinquies' },
    { label: 'Sexies', value: 'sexies' },
    { label: 'Septies', value: 'septies' },
    { label: 'Octies', value: 'octies' },
    { label: 'Nonies', value: 'nonies' }
];

const tracktypeOptions = [
    { label: "Allée", value: "Allée" },
    { label: "Allée privée", value: "Allée privée" },
    { label: "Avenue", value: "Avenue" },
    { label: "Boulevard", value: "Boulevard" },
    { label: "Boulevard périphérique", value: "Boulevard périphérique" },
    { label: "Cité", value: "Cité" },
    { label: "Cour", value: "Cour" },
    { label: "Chemin", value: "Chemin" },
    { label: "Chemin rural", value: "Chemin rural" },
    { label: "Impasse", value: "Impasse" },
    { label: "Lotissement", value: "Lotissement" },
    { label: "Parc", value: "Parc" },
    { label: "Passage", value: "Passage" },
    { label: "Place", value: "Place" },
    { label: "Place de la…", value: "Place de la…" },
    { label: "Promenade", value: "Promenade" },
    { label: "Quai", value: "Quai" },
    { label: "Route", value: "Route" },
    { label: "Route départementale", value: "Route départementale" },
    { label: "Route nationale", value: "Route nationale" },
    { label: "Ruelle", value: "Ruelle" },
    { label: "Résidence", value: "Résidence" },
    { label: "Sentier", value: "Sentier" },
    { label: "Villa", value: "Villa" },
    { label: "Voie", value: "Voie" },
    { label: "Zone industrielle", value: "Zone industrielle" }
];

const countryOptions = [
    { label: "France", value: "FR" },
    ...countries
        .filter(c => c.name !== "France")
        .sort((a, b) => a.name.localeCompare(b.name))
        .map(c => ({ label: c.name, value: c.code }))
];

const formBackground = 'light';
---

<div>
    <h3 class="text-xl-2 font-semibold mb-4">Informations Entreprise</h3>
</div>

<form id="create-form">
    <div class="space-y-2 md:space-y-4 bg-white p-4 rounded-sm mb-4">
        <div class="text-md font-semibold">Entrepreneur</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Radio label="Disposez-vous d'un contrat d'appui ?" id="supportcontract" name="supportcontract" options={supportcontractOptions} required background={formBackground} />
            <Radio label="Demande d'ACRE de moins de 3 ans ?" id="accre" name="accre" options={accreOptions}  required background={formBackground} />
            <Radio label="Avez-vous déjà eu une entreprise ?" id="existingsiren" name="existingsiren" options={existingsirenOptions}  required background={formBackground} />
            <div id="siren-wrapper" class="hidden transition-all duration-300">
                <Input label="SIREN" id="siren" name="siren" required background={formBackground} />
            </div>
            <Select label="Profession actuelle" id="otheractivity" name="otheractivity" options={otheractivityOptions} required background={formBackground} placeholder=""/>
        </div>
    </div>

    <div class="space-y-2 md:space-y-4 bg-white p-4 rounded-sm mb-4">
        <div class="text-md font-semibold">Fiscalité</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Radio label="Souhaitez-vous le régime micro ?" id="micro" name="micro" options={microOptions}  required background={formBackground} />
            <Select label="Périodicité de déclaration CA" id="insuranceorganization" name="insuranceorganization" options={turnoverOptions} required background={formBackground} placeholder=""/>
        </div>
    </div>

    <div class="space-y-2 md:space-y-4 bg-white p-4 rounded-sm mb-4">
        <div class="text-md font-semibold">Activités de l'entreprise</div>
        <Textarea rows={3} label="Description de votre activité principale" id="activity" name="activity" required background={formBackground} class='text-sm' />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Select label="Votre activité sera de forme" id="formofactivity" name="formofactivity" options={formofactivityOptions} required background={formBackground} placeholder=""/>
            <Select label="L'activité sera exercée" id="domiciliation" name="domiciliation" options={domiciliationOptions} required background={formBackground} placeholder=""/>
        </div>
        <div class="grid grid-cols-2 gap-4" id="domiciliationsiren-wrapper" class="hidden transition-all duration-300">
            <Input label="Siren" id="domiciliationsiren" name="domiciliationsiren" required background={formBackground} />
            <Input label="Dénomination" id="domiciliationname" name="domiciliationname" required background={formBackground} />
        </div>
    </div>

    <div id="localaddress-wraper" class="hidden space-y-2 md:space-y-4 bg-white p-4 rounded-sm mb-4 transition-all duration-300">
        <div class="text-md font-semibold">Adresse de l'établissement</div>
        <div class="grid grid-cols-4 gap-4">
            <Input label="N°" id="tracknumber" name="tracknumber" required background={formBackground} class="col-span-1" />
            <div class="col-span-3 grid grid-cols-2 gap-4">
                <Select label="Indice" id="complementnumber" name="complementnumber" options={complementnumberOptions} data-optional="true" background={formBackground} placeholder=""class="w-full" />
                <Select label="Type de voie" id="tracktype" name="tracktype" options={tracktypeOptions} required background={formBackground} placeholder=""class="w-full" />
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Input label="Nom de la voie" id="way" name="way" required background={formBackground} />
            <Input label="Complément d'adresse" id="additionaladdress" name="additionaladdress" data-optional="true" background={formBackground} />
        </div>
        <div class="grid grid-cols-2 gap-4">
            <Input label="Code postal" id="zipcode" name="zipcode" required background={formBackground} />
            <Input label="Ville" id="city" name="city" required background={formBackground} class="capitalize" />
        </div>
        <div class="grid grid-cols-1 gap-4">
            <Select label="Pays" id="country" name="country" options={countryOptions} required background={formBackground} placeholder="" />
        </div>
    </div>

    <div class="flex justify-between my-8">
        <Button href="/forms/create/entrepreneur" variant="primary" size="md" class="uppercase">étape précédente</Button>
        <Button type='submit' variant="primary" size="md" class="uppercase">étape suivante</Button>
    </div>
</form>

<!-- Script côté client -->
<script type="module">
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('create-form');
        if (!form) return;

        // SIREN EXISTANT
        const sirenWrapper = document.getElementById('siren-wrapper');
        const sirenInput = document.getElementById('siren');
        const existingSirens = form.querySelectorAll('input[name="existingsiren"]');

        const toggleSiren = (value) => {
            if (!sirenWrapper || !sirenInput) return;

            if (value === 'oui') {
                sirenWrapper.classList.remove('hidden');
                sirenInput.setAttribute('required', '');
            } else {
                sirenWrapper.classList.add('hidden');
                sirenInput.removeAttribute('required');
            }
        };

        existingSirens.forEach(radio => {
            radio.addEventListener('change', e => toggleSiren(e.target.value));
            if (radio.checked) toggleSiren(radio.value);
        });

        if (sirenInput) {
            sirenInput.addEventListener('input', e => {
                e.target.value = e.target.value.replace(/\D/g, '').slice(0, 9);
            });
        }

        // DOMICILIATION / LMNP / ADRESSE
        const formofactivitySelect = form.querySelector('[name="formofactivity"]');
        const domiciliationSelect = form.querySelector('[name="domiciliation"]');

        const localWrapper = document.getElementById('localaddress-wraper');
        const localInputs = localWrapper
            ? localWrapper.querySelectorAll('input, select')
            : [];

        const domiciliationsirenWrapper = document.getElementById('domiciliationsiren-wrapper');
        const domiciliationsirenInput = document.getElementById('domiciliationsiren');
        const domiciliationnameInput = document.getElementById('domiciliationname');

        // LMNP
        const handleLMNP = () => {
            let lmnpOption = domiciliationSelect.querySelector('option[value="lmnp"]');

            if (formofactivitySelect.value === 'location_biens') {
                if (!lmnpOption) {
                    lmnpOption = document.createElement('option');
                    lmnpOption.value = 'lmnp';
                    lmnpOption.textContent = 'à l’adresse du bien loué (LMNP)';
                    domiciliationSelect.appendChild(lmnpOption);
                }

                domiciliationSelect.value = 'lmnp';
                domiciliationSelect.disabled = true;
            } else {
                domiciliationSelect.disabled = false;
                if (lmnpOption) lmnpOption.remove();
            }
        };

        const handleAddress = () => {
            const needsAddress = domiciliationSelect.value !== 'personnel';

            if (needsAddress) {
                localWrapper.classList.remove('hidden');
                localInputs.forEach(el => {
                    if (el.dataset.optional !== 'true') {
                        el.setAttribute('required', '');
                    }
                });
            } else {
                localWrapper.classList.add('hidden');
                localInputs.forEach(el => el.removeAttribute('required'));
            }
        };

        // Centre de domiciliation
        const handleDomiciliationCenter = () => {
            if (domiciliationSelect.value === 'domiciliation') {
                domiciliationsirenWrapper.classList.remove('hidden');
                domiciliationsirenInput.setAttribute('required', '');
                domiciliationnameInput.setAttribute('required', '');
            } else {
                domiciliationsirenWrapper.classList.add('hidden');
                domiciliationsirenInput.removeAttribute('required');
                domiciliationnameInput.removeAttribute('required');
            }
        };

        if (domiciliationsirenInput) {
            domiciliationsirenInput.addEventListener('input', e => {
                e.target.value = e.target.value.replace(/\D/g, '').slice(0, 9);
            });
        }

        // Synchronisation
        const syncForm = () => {
            handleLMNP();
            handleAddress();
            handleDomiciliationCenter();
        };

        formofactivitySelect.addEventListener('change', syncForm);
        domiciliationSelect.addEventListener('change', syncForm);

        // Init
        syncForm();
    });
</script>




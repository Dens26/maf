---
import Stepper from '@components/forms/Stepper.astro';
import { getBackgroundColor, getPaddingClass } from '@utils/styleUtils';
import Button from '@components/ui/Button.astro';
import type { ThemeColor, PaddingSize } from '@utils/styleUtils';

export interface Props {
    background?: ThemeColor;
    padding?: PaddingSize;
    paddingTop?: PaddingSize;
    paddingBottom?: PaddingSize;
}

const { background = 'base', padding, paddingTop, paddingBottom } = Astro.props;
const bgColor = getBackgroundColor(background);
const paddingClass = getPaddingClass({ padding, paddingTop, paddingBottom });
---

<section class:list={[bgColor, paddingClass]}>
    <div class="site-container px-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div>
                <Stepper currentStep={3} id="stepper" />
            </div>
        <div class="md:col-span-2">
            <h2 class="text-xl-2 font-semibold mb-4">Récapitulatif de vos informations</h2>
            <div id="recap-container" class="space-y-4 bg-white p-4 rounded-sm"></div>

            <div class="flex justify-between my-8">
                <Button href="/forms/create/business" variant="primary" size="md" class="uppercase">Étape précédente</Button>
                <Button variant="primary" size="md" class="uppercase" id="submit-formality">Envoyer ma formalité</Button>
            </div>
        </div>
        </div>
    </div>
</section>

<script type="module">
document.addEventListener('DOMContentLoaded', () => {
    const STORAGE_KEY_ENTREPRENEUR = 'create-entrepreneur-form';
    const STORAGE_KEY_BUSINESS = 'create-business-form';

    const recapContainer = document.getElementById('recap-container');
    const submitBtn = document.getElementById('submit-formality');

    if (!recapContainer || !submitBtn) return;

    // Récupérer les données depuis localStorage
    const entrepreneur = JSON.parse(localStorage.getItem(STORAGE_KEY_ENTREPRENEUR) || '{}');
    const business = JSON.parse(localStorage.getItem(STORAGE_KEY_BUSINESS) || '{}');

    // Fonction utilitaire pour générer une ligne de récap
    const createRecapLine = (label, value) => {
        const div = document.createElement('div');
        div.className = 'flex justify-between p-2 border-b border-gray-200';
        div.innerHTML = `<strong>${label}:</strong> <span>${value || '-'}</span>`;
        return div;
    };

    // Affichage des données
    const displayRecap = () => {
        recapContainer.innerHTML = '';
        
        if (Object.keys(entrepreneur).length) {
            recapContainer.appendChild(createRecapLine('Nom', entrepreneur.name));
            recapContainer.appendChild(createRecapLine('Prénom', entrepreneur.firstname));
            recapContainer.appendChild(createRecapLine('Date de naissance', entrepreneur.birthdate));
            recapContainer.appendChild(createRecapLine('Pays de naissance', entrepreneur.birthcountry));
            recapContainer.appendChild(createRecapLine('Nationalité', entrepreneur.nationality));
            recapContainer.appendChild(createRecapLine('Assurance santé', entrepreneur.insuranceorganization));
        }

        if (Object.keys(business).length) {
            recapContainer.appendChild(createRecapLine('Nom de l’entreprise', business.businessName));
            recapContainer.appendChild(createRecapLine('SIREN', business.siren));
            recapContainer.appendChild(createRecapLine('Forme d’activité', business.formofactivity));
            recapContainer.appendChild(createRecapLine('Adresse', `${business.tracknumber || ''} ${business.tracktype || ''} ${business.way || ''}, ${business.zipcode || ''} ${business.city || ''}`));
            recapContainer.appendChild(createRecapLine('Domiciliation', business.domiciliation));
        }
    };

    displayRecap();

    // Envoi des données
    submitBtn.addEventListener('click', async () => {
        try {
        const response = await fetch('/api/send-formalite', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ entrepreneur, business })
        });

        if (!response.ok) throw new Error('Erreur lors de l’envoi de la formalité.');

        alert('Formalité envoyée avec succès !');
        localStorage.removeItem(STORAGE_KEY_ENTREPRENEUR);
        localStorage.removeItem(STORAGE_KEY_BUSINESS);
        window.location.href = '/forms/create/confirmation';
        } catch (error) {
        console.error(error);
        alert('Erreur lors de l’envoi de la formalité. Veuillez réessayer.');
        }
    });
});
</script>

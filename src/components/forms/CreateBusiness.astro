---
import Button from '@components/ui/Button.astro';
import Input from '@components/ui/form/Input.astro';
import Radio from '@components/ui/form/Radio.astro';
import Select from '@components/ui/form/Select.astro';
import Date from '@components/ui/form/Date.astro';
import Textarea from '@components/ui/form/Textarea.astro';
import countries from 'public/data/countries.json';

const existingsirenOptions = [
    { label: 'Oui', value: 'oui' },
    { label: 'Non', value: 'non' },
];

const microOptions = [
    { label: 'Oui', value: 'oui' },
    { label: 'Non', value: 'non' },
];

const accreOptions = [
    { label: 'Oui', value: 'oui' },
    { label: 'Non', value: 'non' },
];

const supportcontractOptions = [
    { label: 'Oui', value: 'oui' },
    { label: 'Non', value: 'non' },
];

const turnoverOptions = [
    { label: 'Mensuel', value: 'mensuel' },
    { label: 'Trimestriel', value: 'trimestriel' },
];

const otheractivityOptions = [
    { label: 'Sans activité', value: 'Sans activité' },
    { label: 'Non salarié non agricole', value: 'Non salarié non agricole' },
    { label: 'Pension d\'invalidité', value: 'Invalidité' },
    { label: 'Retraité', value: 'Retraité' },
    { label: 'Salarié', value: 'Salarié' },
    { label: 'Salarié agricole', value: 'Salarié agricole' },
    { label: 'Autre', value: 'Autre' },
];

const domiciliationOptions = [
    { label: 'au domicile personnel', value: 'personnel' },
    { label: 'dans un local professionnel', value: 'local' },
    { label: 'à l’adresse du bien loué (LMNP)', value: 'lmnp' },
    { label: 'dans un centre de domiciliation', value: 'domiciliation' }
];

const formofactivityOptions = [
    { label: 'libérale', value: 'liberale' },
    { label: 'commerciale', value: 'commerciale' },
    { label: 'artisanale', value: 'artisanale' },
    { label: 'location de biens immobiliers', value: 'location_biens' },
    { label: 'agricole', value: 'agricole' }
];

const formofsecondaryactivityOptions = [
    { label: 'libérale', value: 'liberale' },
    { label: 'commerciale', value: 'commerciale' },
    { label: 'artisanale', value: 'artisanale' },
    { label: 'agricole', value: 'agricole' }
];

const complementnumberOptions = [
    { label: '', value: '' },
    { label: 'Bis', value: 'bis' },
    { label: 'Ter', value: 'ter' },
    { label: 'Quater', value: 'quater' },
    { label: 'Quinquies', value: 'quinquies' },
    { label: 'Sexies', value: 'sexies' },
    { label: 'Septies', value: 'septies' },
    { label: 'Octies', value: 'octies' },
    { label: 'Nonies', value: 'nonies' }
];

const tracktypeOptions = [
    { label: "Allée", value: "Allée" },
    { label: "Allée privée", value: "Allée privée" },
    { label: "Avenue", value: "Avenue" },
    { label: "Boulevard", value: "Boulevard" },
    { label: "Boulevard périphérique", value: "Boulevard périphérique" },
    { label: "Cité", value: "Cité" },
    { label: "Cour", value: "Cour" },
    { label: "Chemin", value: "Chemin" },
    { label: "Chemin rural", value: "Chemin rural" },
    { label: "Impasse", value: "Impasse" },
    { label: "Lotissement", value: "Lotissement" },
    { label: "Parc", value: "Parc" },
    { label: "Passage", value: "Passage" },
    { label: "Place", value: "Place" },
    { label: "Place de la…", value: "Place de la…" },
    { label: "Promenade", value: "Promenade" },
    { label: "Quai", value: "Quai" },
    { label: "Route", value: "Route" },
    { label: "Route départementale", value: "Route départementale" },
    { label: "Route nationale", value: "Route nationale" },
    { label: "Ruelle", value: "Ruelle" },
    { label: "Résidence", value: "Résidence" },
    { label: "Sentier", value: "Sentier" },
    { label: "Villa", value: "Villa" },
    { label: "Voie", value: "Voie" },
    { label: "Zone industrielle", value: "Zone industrielle" }
];

const countryOptions = [
    { label: "France", value: "FR" },
    ...countries
        .filter(c => c.name !== "France")
        .sort((a, b) => a.name.localeCompare(b.name))
        .map(c => ({ label: c.name, value: c.code }))
];

const formBackground = 'light';
---

<div>
    <h3 class="text-xl-2 font-semibold mb-4">Informations Entreprise</h3>
</div>

<form id="create-form" action="/forms/create/recapitulatif">

  <!-- ENTREPRENEUR -->
  <div class="space-y-2 sm:space-y-4 bg-white p-2 sm:p-4 rounded-sm mb-4">
    <div class="text-md font-semibold">Entrepreneur</div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-4">
      <Radio label="Disposez-vous d'un contrat d'appui ?" id="supportcontract" name="supportcontract" options={supportcontractOptions} required background={formBackground} />
      <Radio label="Demande d'ACRE de moins de 3 ans ?" id="accre" name="accre" options={accreOptions} required background={formBackground} />
      <Select label="Profession actuelle" id="otheractivity" name="otheractivity" options={otheractivityOptions} required background={formBackground} />
      <div id="otheractivitydetail-wrapper" class="hidden transition-all duration-300">
        <Input label="Précisez votre profession" id="otheractivitydetail" name="otheractivitydetail" required background={formBackground} />
      </div>
    </div>
  </div>

  <!-- ACTIVITÉ ANTÉRIEURE -->
  <div class="space-y-2 sm:space-y-4 bg-white p-2 sm:p-4 rounded-sm mb-4">
    <div class="text-md font-semibold">Activité antérieure en France ou à l'étranger</div>
    <Radio label="Avez-vous déjà eu une activité non salarié ?" id="previousselfemployedactivity" name="previousselfemployedactivity" options={existingsirenOptions} required background={formBackground} />
    <div id="oldactivity-wrapper" class="hidden transition-all duration-300 flex flex-wrap gap-2 sm:gap-4">
      <div id="sirencountry-wrapper" class="flex-1 min-w-[48%]"><Select label="Pays de l'activité" id="sirencountry" name="sirencountry" options={countryOptions} required background={formBackground} /></div>
      <div id="siren-wrapper" class="hidden transition-all duration-300 flex-1 min-w-[48%]"><Input label="SIREN" id="siren" name="siren" required background={formBackground} /></div>
      <div id="oldactivitydate-wrapper" class="flex-1 min-w-[48%]"><Date label="Fin de l'activité" id="oldactivitydate" name="oldactivitydate" required background={formBackground} /></div>
      <div class="flex-1 min-w-[48%]"><Input label="Description de l'activité" id="oldactivity" name="oldactivity" required background={formBackground} /></div>
    </div>
  </div>

  <!-- FISCALITÉ -->
  <div class="space-y-2 sm:space-y-4 bg-white p-2 sm:p-4 rounded-sm mb-4">
    <div class="text-md font-semibold">Fiscalité</div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-4">
      <Radio label="Souhaitez-vous le régime micro ?" id="micro" name="micro" options={microOptions} required background={formBackground} />
      <Select label="Périodicité de déclaration CA" id="insuranceorganization" name="insuranceorganization" options={turnoverOptions} required background={formBackground} />
    </div>
  </div>

  <!-- ACTIVITÉS DE L'ENTREPRISE -->
  <div class="space-y-2 sm:space-y-4 bg-white p-2 sm:p-4 rounded-sm mb-4">
    <div class="text-md font-semibold">Activités de l'entreprise</div>
    <Textarea rows={3} label="Description de votre activité principale" id="activity" name="activity" required background={formBackground} class="text-sm" />
    <div class="grid grid-cols-2 gap-2 sm:gap-4">
      <Select label="Forme de l'activité" id="formofactivity" name="formofactivity" options={formofactivityOptions} required background={formBackground} />
      <Select label="Lieu de l'activité" id="domiciliation" name="domiciliation" options={domiciliationOptions} required background={formBackground} />
      <Input label="Nom commercial" id="businessname" name="businessname" background={formBackground} />
      <div id="nbrofactivities-wrapper" class="hidden">
        <Input type="number" min="0" max="5" label="Activités secondaires" id="nbrofactivies" name="nbrofactivies" background={formBackground} />
      </div>
    </div>
    <div id="domiciliationsiren-wrapper" class="grid grid-cols-2 gap-2 sm:gap-4 hidden transition-all duration-300">
      <Input label="Dénomination" id="domiciliationname" name="domiciliationname" required background={formBackground} />
      <Input label="Siren" id="domiciliationsiren" name="domiciliationsiren" required background={formBackground} />
    </div>
    <div id="secondary-activities-container" class="space-y-2 sm:space-y-4"></div>
    <template id="secondary-activity-template">
      <div class="grid grid-cols-1 sm:grid-cols-4 gap-2 sm:gap-4 border border-primary/50 p-2 rounded-md shadow-sm">
        <div class="sm:col-span-3"><Textarea label="Description de l'activité secondaire" rows={3} required /></div>
        <Select label="Forme de l'activité secondaire" options={formofsecondaryactivityOptions} required class="col-span-1" />
      </div>
    </template>
  </div>

  <!-- ADRESSE DE L'ÉTABLISSEMENT -->
  <div id="localaddress-wrapper" class="hidden space-y-2 sm:space-y-4 bg-white p-2 sm:p-4 rounded-sm mb-4 transition-all duration-300">
    <div class="text-md font-semibold">Adresse de l'établissement</div>
    <div class="grid grid-cols-12 gap-2 sm:gap-4">
      <div class="col-span-2"><Input label="N°" id="tracknumber" name="tracknumber" required background={formBackground} autocomplete="street-address" /></div>
      <div class="col-span-3"><Select label="Indice" id="complementnumber" name="complementnumber" options={complementnumberOptions} data-optional="true" background={formBackground} placeholder="" /></div>
      <div class="col-span-7"><Select label="Type de voie" id="tracktype" name="tracktype" options={tracktypeOptions} required background={formBackground} /></div>
    </div>
    <Input label="Nom de la voie" id="way" name="way" required background={formBackground} autocomplete="street-address" />
    <div class="grid grid-cols-2 gap-2 sm:gap-4">
      <Input label="Code postal" id="zipcode" name="zipcode" required background={formBackground} autocomplete="postal-code" />
      <Input label="Ville" id="city" name="city" required background={formBackground} class="capitalize" autocomplete="address-level2" />
    </div>
    <div class="grid grid-cols-2 gap-2 sm:gap-4">
      <Input label="Complément" id="additionaladdress" name="additionaladdress" data-optional="true" background={formBackground} autocomplete="address-line2" />
      <Select label="Pays" id="country" name="country" options={countryOptions} required background={formBackground} autocomplete="country" />
    </div>
  </div>

  <!-- NAVIGATION -->
  <div class="flex justify-between my-8">
    <Button href="/forms/create/entrepreneur" variant="primary" size="md" class="uppercase">étape précédente</Button>
    <Button type="submit" variant="primary" size="md" class="uppercase">étape suivante</Button>
  </div>
</form>


<!-- SCRIPT JS -->
<script type="module">
document.addEventListener('DOMContentLoaded', () => {

  const form = document.getElementById('create-form');
  if (!form) return;

  const STORAGE_KEY = 'create-business-form';

  const nbrofactivitiesWrapper = document.getElementById('nbrofactivities-wrapper');
  const nbrofactivitiesInput = document.getElementById('nbrofactivies');
  const container = document.getElementById('secondary-activities-container');
  const template = document.getElementById('secondary-activity-template');

  /*** ================= STORAGE ================= ***/
  const saveForm = () => {
    const data = {};
    new FormData(form).forEach((value, key) => { data[key] = value; });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  };

  const restoreForm = () => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) return;

    const data = JSON.parse(saved);

    Object.entries(data).forEach(([name, value]) => {
      if (name.startsWith('secondaryActivities')) return;
      const field = form.querySelector(`[name="${name}"]`);
      if (!field) return;

      if (field.type === 'radio') {
        const radio = form.querySelector(`[name="${name}"][value="${value}"]`);
        if (radio) radio.checked = true;
      } else {
        field.value = value;
      }
    });

    const secondaryKeys = Object.keys(data).filter(k => k.startsWith('secondaryActivities'));
    if (secondaryKeys.length) {
      const count = secondaryKeys.reduce((max, key) => {
        const match = key.match(/\[(\d+)\]/);
        return match ? Math.max(max, parseInt(match[1])) : max;
      }, -1) + 1;

      nbrofactivitiesInput.value = count;
      renderSecondaryActivities();

      secondaryKeys.forEach(key => {
        const field = form.querySelector(`[name="${key}"]`);
        if (field) field.value = data[key];
      });
    }
  };

  form.addEventListener('input', saveForm);
  form.addEventListener('change', saveForm);

  /*** ================= AUTRES ACTIVITÉS ================= ***/
  const otherActivityWrapper = document.getElementById('otheractivitydetail-wrapper');
  const otherActivityInput = document.getElementById('otheractivitydetail');
  const otherActivitySelect = form.querySelector('[name="otheractivity"]');

  const toggleOtherActivityDetail = () => {
    if (!otherActivityWrapper || !otherActivityInput || !otherActivitySelect) return;

    if (otherActivitySelect.value === 'Autre') {
      otherActivityWrapper.classList.remove('hidden');
      otherActivityInput.required = true;
    } else {
      otherActivityWrapper.classList.add('hidden');
      otherActivityInput.required = false;
      otherActivityInput.value = '';
    }
  };

  otherActivitySelect.addEventListener('change', toggleOtherActivityDetail);

  /*** ================= ACTIVITÉ ANTÉRIEURE ================= ***/
  const sirenCountryWrapper = document.getElementById('sirencountry-wrapper');
  const sirenWrapper = document.getElementById('siren-wrapper');
  const oldActivityWrapper = document.getElementById('oldactivity-wrapper');
  const oldActivityDateWrapper = document.getElementById('oldactivitydate-wrapper');

  const sirenInput = document.getElementById('siren');
  const oldActivityInput = document.getElementById('oldactivity');
  const oldActivityDateInput = document.getElementById('oldactivitydate');
  const sirenCountrySelect = form.querySelector('[name="sirencountry"]');
  const previousSelfEmployedActivity = document.querySelectorAll(
    'input[name="previousselfemployedactivity"]'
  );

  const updatePreviousActivityFields = () => {
    const radioValue =
      Array.from(previousSelfEmployedActivity).find(r => r.checked)?.value || 'non';

    const hasPreviousActivity = radioValue === 'oui';
    const countryValue = sirenCountrySelect?.value || '';
    const showSiren = hasPreviousActivity && countryValue === 'FR';

    // Affichage global
    oldActivityWrapper.classList.toggle('hidden', !hasPreviousActivity);
    sirenCountryWrapper.classList.toggle('hidden', !hasPreviousActivity);
    oldActivityDateWrapper.classList.toggle('hidden', !hasPreviousActivity);

    // Required
    sirenCountrySelect.required = hasPreviousActivity;
    oldActivityInput.required = hasPreviousActivity;
    oldActivityDateInput.required = hasPreviousActivity;

    // SIREN uniquement si France
    sirenWrapper.classList.toggle('hidden', !showSiren);
    sirenInput.required = showSiren;

    // Nettoyage
    if (!hasPreviousActivity) {
      sirenCountrySelect.value = '';
      sirenInput.value = '';
      oldActivityInput.value = '';
      oldActivityDateInput.value = '';
    } else if (!showSiren) {
      sirenInput.value = '';
    }
  };

  previousSelfEmployedActivity.forEach(radio =>
    radio.addEventListener('change', updatePreviousActivityFields)
  );

  sirenCountrySelect?.addEventListener('change', updatePreviousActivityFields);

  sirenInput?.addEventListener('input', e => {
    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 9);
  });

  /*** ================= ADRESSE / DOMICILIATION ================= ***/
  const formOfActivitySelect = form.querySelector('[name="formofactivity"]');
  const domiciliationSelect = form.querySelector('[name="domiciliation"]');
  const localWrapper = document.getElementById('localaddress-wrapper');
  const localInputs = localWrapper ? localWrapper.querySelectorAll('input, select') : [];
  const domiciliationsirenWrapper = document.getElementById('domiciliationsiren-wrapper');
  const domiciliationsirenInput = document.getElementById('domiciliationsiren');
  const domiciliationnameInput = document.getElementById('domiciliationname');

  const handleLMNP = () => {
    let lmnpOption = domiciliationSelect.querySelector('option[value="lmnp"]');

    if (formOfActivitySelect.value === 'location_biens') {
      if (!lmnpOption) {
        lmnpOption = document.createElement('option');
        lmnpOption.value = 'lmnp';
        lmnpOption.textContent = 'à l’adresse du bien loué (LMNP)';
        domiciliationSelect.appendChild(lmnpOption);
      }
      domiciliationSelect.value = 'lmnp';
      domiciliationSelect.disabled = true;
    } else {
      domiciliationSelect.disabled = false;
      if (lmnpOption) lmnpOption.remove();
    }
  };

  const handleAddress = () => {
    const needsAddress =
      domiciliationSelect.value !== 'personnel' &&
      domiciliationSelect.value !== '';

    if (needsAddress) {
      localWrapper.classList.remove('hidden');
      localInputs.forEach(el => {
        if (el.dataset.optional !== 'true' && el.id !== 'complementnumber' && el.id !== 'additionaladdress') {
          el.required = true;
        }
      });
    } else {
      localWrapper.classList.add('hidden');
      localInputs.forEach(el => {
        el.required = false;
        el.value = '';
      });
    }
  };

  const handleDomiciliationCenter = () => {
    if (domiciliationSelect.value === 'domiciliation') {
      domiciliationsirenWrapper.classList.remove('hidden');
      domiciliationsirenInput.required = true;
      domiciliationnameInput.required = true;
    } else {
      domiciliationsirenWrapper.classList.add('hidden');
      domiciliationsirenInput.required = false;
      domiciliationnameInput.required = false;
      domiciliationsirenInput.value = '';
      domiciliationnameInput.value = '';
    }
  };

  domiciliationsirenInput?.addEventListener('input', e => {
    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 9);
  });

  /*** ================= ACTIVITÉS SECONDAIRES ================= ***/
  const renderSecondaryActivities = () => {
    const count = Number(nbrofactivitiesInput.value) || 0;

    const existingData = [];
    container.querySelectorAll('.grid.grid-cols-4').forEach(el => {
      existingData.push({
        desc: el.querySelector('textarea')?.value || '',
        form: el.querySelector('select')?.value || ''
      });
    });

    container.innerHTML = '';

    for (let i = 0; i < count; i++) {
      const clone = template.content.cloneNode(true);
      const textarea = clone.querySelector('textarea');
      const select = clone.querySelector('select');

      textarea.name = `secondaryActivities[${i}][description]`;
      select.name = `secondaryActivities[${i}][form]`;

      if (existingData[i]) {
        textarea.value = existingData[i].desc;
        select.value = existingData[i].form;
      }

      textarea.addEventListener('input', saveForm);
      select.addEventListener('change', saveForm);

      container.appendChild(clone);
    }
  };

  const handleAddActivity = () => {
    const isSecondaryAllowed =
      domiciliationSelect.value !== 'lmnp' &&
      domiciliationSelect.value !== '';

    if (!isSecondaryAllowed) {
      nbrofactivitiesWrapper.classList.add('hidden');
      nbrofactivitiesInput.required = false;
      nbrofactivitiesInput.value = '';
      container.innerHTML = '';
      return;
    }

    nbrofactivitiesWrapper.classList.remove('hidden');
    nbrofactivitiesInput.required = true;

    if (!nbrofactivitiesInput.value) nbrofactivitiesInput.value = 0;
    renderSecondaryActivities();
  };

  nbrofactivitiesInput.addEventListener('input', () => {
    let value = parseInt(nbrofactivitiesInput.value.replace(/\D/g, ''), 10);
    if (isNaN(value)) value = 0;
    value = Math.min(Math.max(value, 0), 5);
    nbrofactivitiesInput.value = value;
    renderSecondaryActivities();
  });

  /*** ================= SYNC ================= ***/
  const syncForm = () => {
    handleLMNP();
    handleAddress();
    handleDomiciliationCenter();
    handleAddActivity();
  };

  formOfActivitySelect.addEventListener('change', syncForm);
  domiciliationSelect.addEventListener('change', syncForm);

  /*** ================= INIT ================= ***/
  restoreForm();
  toggleOtherActivityDetail();
  updatePreviousActivityFields();
  syncForm();

});
</script>

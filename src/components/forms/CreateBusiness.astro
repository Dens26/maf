---
import Button from '@components/ui/Button.astro';
import Input from '@components/ui/form/Input.astro';
import Radio from '@components/ui/form/Radio.astro';
import Select from '@components/ui/form/Select.astro';
import Textarea from '@components/ui/form/Textarea.astro';
import countries from '@data/countries.json';

const existingsirenOptions = [
    { label: 'Oui', value: 'oui' },
    { label: 'Non', value: 'non' },
];

const microOptions = [
    { label: 'Oui', value: 'oui' },
    { label: 'Non', value: 'non' },
];

const accreOptions = [
    { label: 'Oui', value: 'oui' },
    { label: 'Non', value: 'non' },
];

const supportcontractOptions = [
    { label: 'Oui', value: 'oui' },
    { label: 'Non', value: 'non' },
];

const nbrofactivities = [
    { label: 'Oui', value: 'oui' },
    { label: 'Non', value: 'non' },
];

const turnoverOptions = [
    { label: 'Mensuel', value: 'mensuel' },
    { label: 'Trimestriel', value: 'trimestriel' },
];

const otheractivityOptions = [
    { label: 'Sans activité', value: 'Sans activité' },
    { label: 'Non salarié non agricole', value: 'Non salarié non agricole' },
    { label: 'Pension d\'invalidité', value: 'Invalidité' },
    { label: 'Retraité', value: 'Retraité' },
    { label: 'Salarié', value: 'Salarié' },
    { label: 'Salarié agricole', value: 'Salarié agricole' },
    { label: 'Autre', value: 'Autre' },
];

const domiciliationOptions = [
    { label: 'au domicile personnel', value: 'personnel' },
    { label: 'dans un local professionnel', value: 'local' },
    { label: 'à l’adresse du bien loué (LMNP)', value: 'lmnp' },
    { label: 'dans un centre de domiciliation', value: 'domiciliation' }
];

const formofactivityOptions = [
    { label: 'libérale', value: 'liberale' },
    { label: 'commerciale', value: 'commerciale' },
    { label: 'artisanale', value: 'artisanale' },
    { label: 'location de biens immobiliers', value: 'location_biens' },
    { label: 'agricole', value: 'agricole' }
];

const formofsecondaryactivityOptions = [
    { label: 'libérale', value: 'liberale' },
    { label: 'commerciale', value: 'commerciale' },
    { label: 'artisanale', value: 'artisanale' },
    { label: 'agricole', value: 'agricole' }
];

const complementnumberOptions = [
    { label: 'Bis', value: 'bis' },
    { label: 'Ter', value: 'ter' },
    { label: 'Quater', value: 'quater' },
    { label: 'Quinquies', value: 'quinquies' },
    { label: 'Sexies', value: 'sexies' },
    { label: 'Septies', value: 'septies' },
    { label: 'Octies', value: 'octies' },
    { label: 'Nonies', value: 'nonies' }
];

const tracktypeOptions = [
    { label: "Allée", value: "Allée" },
    { label: "Allée privée", value: "Allée privée" },
    { label: "Avenue", value: "Avenue" },
    { label: "Boulevard", value: "Boulevard" },
    { label: "Boulevard périphérique", value: "Boulevard périphérique" },
    { label: "Cité", value: "Cité" },
    { label: "Cour", value: "Cour" },
    { label: "Chemin", value: "Chemin" },
    { label: "Chemin rural", value: "Chemin rural" },
    { label: "Impasse", value: "Impasse" },
    { label: "Lotissement", value: "Lotissement" },
    { label: "Parc", value: "Parc" },
    { label: "Passage", value: "Passage" },
    { label: "Place", value: "Place" },
    { label: "Place de la…", value: "Place de la…" },
    { label: "Promenade", value: "Promenade" },
    { label: "Quai", value: "Quai" },
    { label: "Route", value: "Route" },
    { label: "Route départementale", value: "Route départementale" },
    { label: "Route nationale", value: "Route nationale" },
    { label: "Ruelle", value: "Ruelle" },
    { label: "Résidence", value: "Résidence" },
    { label: "Sentier", value: "Sentier" },
    { label: "Villa", value: "Villa" },
    { label: "Voie", value: "Voie" },
    { label: "Zone industrielle", value: "Zone industrielle" }
];

const countryOptions = [
    { label: "France", value: "FR" },
    ...countries
        .filter(c => c.name !== "France")
        .sort((a, b) => a.name.localeCompare(b.name))
        .map(c => ({ label: c.name, value: c.code }))
];

const formBackground = 'light';
---

<div>
    <h3 class="text-xl-2 font-semibold mb-4">Informations Entreprise</h3>
</div>

<form id="create-form">
    <div class="space-y-2 md:space-y-4 bg-white p-4 rounded-sm mb-4">
        <div class="text-md font-semibold">Entrepreneur</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Radio label="Disposez-vous d'un contrat d'appui ?" id="supportcontract" name="supportcontract" options={supportcontractOptions} required background={formBackground} />
            <Radio label="Demande d'ACRE de moins de 3 ans ?" id="accre" name="accre" options={accreOptions}  required background={formBackground} />
            <Radio label="Avez-vous déjà eu une entreprise ?" id="existingsiren" name="existingsiren" options={existingsirenOptions}  required background={formBackground} />
            <div id="siren-wrapper" class="hidden transition-all duration-300">
                <Input label="SIREN" id="siren" name="siren" required background={formBackground} />
            </div>
            <Select label="Profession actuelle" id="otheractivity" name="otheractivity" options={otheractivityOptions} required background={formBackground} placeholder="" />
            <div id="otheractivitydetail-wrapper" class="hidden transition-all duration-300">
                <Input label="Précisez votre profession" id="otheractivitydetail" name="otheractivitydetail" required background={formBackground} />
            </div>
        </div>
    </div>

    <div class="space-y-2 md:space-y-4 bg-white p-4 rounded-sm mb-4">
        <div class="text-md font-semibold">Fiscalité</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Radio label="Souhaitez-vous le régime micro ?" id="micro" name="micro" options={microOptions}  required background={formBackground} />
            <Select label="Périodicité de déclaration CA" id="insuranceorganization" name="insuranceorganization" options={turnoverOptions} required background={formBackground} placeholder="" />
        </div>
    </div>

    <div class="space-y-2 md:space-y-4 bg-white p-4 rounded-sm mb-4">
        <div class="text-md font-semibold">Activités de l'entreprise</div>
        <Textarea rows={3} label="Description de votre activité principale" id="activity" name="activity" required background={formBackground} class='text-sm' />
        <div class="grid grid-cols-2 gap-4">
            <Select label="Votre activité sera de forme" id="formofactivity" name="formofactivity" options={formofactivityOptions} required background={formBackground} placeholder="" />
            <Select label="L'activité sera exercée" id="domiciliation" name="domiciliation" options={domiciliationOptions} required background={formBackground} placeholder="" />
            <Input label="Nom commercial (optionel)" id="businessname" name="businessname" background={formBackground} />
            <div id="nbrofactivities-wrapper" class="hidden">
                <Input type='number' min="0" max="5" label="Nombre d’activités secondaires" id="nbrofactivies" name="nbrofactivies" background={formBackground} />
            </div>
        </div>
        <div id="domiciliationsiren-wrapper" class="grid grid-cols-2 gap-4 hidden transition-all duration-300">
            <Input label="Siren" id="domiciliationsiren" name="domiciliationsiren" required background={formBackground} />
            <Input label="Dénomination" id="domiciliationname" name="domiciliationname" required background={formBackground} />
        </div>
        <div id="secondary-activities-container" class="space-y-4"></div>
        <template id="secondary-activity-template">
            <div class="grid grid-cols-4 gap-4">
                <div class="col-span-3">
                    <Textarea label="Description de l'activité secondaire" rows={1} required />
                </div>
                <Select label="Forme" options={formofsecondaryactivityOptions} required placeholder="" class="col-span-1" />
            </div>
        </template>
    </div>

    <div id="localaddress-wrapper" class="hidden space-y-2 md:space-y-4 bg-white p-4 rounded-sm mb-4 transition-all duration-300">
        <div class="text-md font-semibold">Adresse de l'établissement</div>
        <div class="grid grid-cols-4 gap-4">
            <Input label="N°" id="tracknumber" name="tracknumber" required background={formBackground} class="col-span-1" />
            <div class="col-span-3 grid grid-cols-2 gap-4">
                <Select label="Indice" id="complementnumber" name="complementnumber" options={complementnumberOptions} data-optional="true" background={formBackground} placeholder="" class="w-full" />
                <Select label="Type de voie" id="tracktype" name="tracktype" options={tracktypeOptions} required background={formBackground} placeholder=""class="w-full" />
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Input label="Nom de la voie" id="way" name="way" required background={formBackground} />
            <Input label="Complément d'adresse" id="additionaladdress" name="additionaladdress" data-optional="true" background={formBackground} />
        </div>
        <div class="grid grid-cols-2 gap-4">
            <Input label="Code postal" id="zipcode" name="zipcode" required background={formBackground} />
            <Input label="Ville" id="city" name="city" required background={formBackground} class="capitalize" />
        </div>
        <div class="grid grid-cols-1 gap-4">
            <Select label="Pays" id="country" name="country" options={countryOptions} required background={formBackground} placeholder="" />
        </div>
    </div>

    <div class="flex justify-between my-8">
        <Button href="/forms/create/entrepreneur" variant="primary" size="md" class="uppercase">étape précédente</Button>
        <Button type='submit' variant="primary" size="md" class="uppercase">étape suivante</Button>
    </div>
</form>

<!-- Script côté client -->
<script type="module">
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('create-form');
        if (!form) return;

        /*** AUTRE ACTIVITÉ ***/
        const otherActivityWrapper = document.getElementById('otheractivitydetail-wrapper');
        const otherActivityInput = document.getElementById('otheractivitydetail');
        const otherActivitySelect = form.querySelector('[name="otheractivity"]');

        const toggleOtherActivityDetail = () => {
            if (!otherActivityWrapper || !otherActivityInput || !otherActivitySelect) return;

            if (otherActivitySelect.value === 'Autre') {
                otherActivityWrapper.classList.remove('hidden');
                otherActivityInput.required = true;
            } else {
                otherActivityWrapper.classList.add('hidden');
                otherActivityInput.required = false;
                otherActivityInput.value = '';
            }
        };
        otherActivitySelect.addEventListener('change', toggleOtherActivityDetail);
        toggleOtherActivityDetail();

        /*** SIREN EXISTANT ***/
        const sirenWrapper = document.getElementById('siren-wrapper');
        const sirenInput = document.getElementById('siren');
        const existingSirens = form.querySelectorAll('input[name="existingsiren"]');

        const toggleSiren = (value) => {
            if (!sirenWrapper || !sirenInput) return;
            if (value === 'oui') {
                sirenWrapper.classList.remove('hidden');
                sirenInput.required = true;
            } else {
                sirenWrapper.classList.add('hidden');
                sirenInput.required = false;
            }
        };
        existingSirens.forEach(radio => {
            radio.addEventListener('change', e => toggleSiren(e.target.value));
            if (radio.checked) toggleSiren(radio.value);
        });
        if (sirenInput)
            sirenInput.addEventListener('input', e => { e.target.value = e.target.value.replace(/\D/g, '').slice(0, 9); });

        /*** DOMICILIATION / LMNP / ADRESSE ***/
        const formOfActivitySelect = form.querySelector('[name="formofactivity"]');
        const domiciliationSelect = form.querySelector('[name="domiciliation"]');
        const localWrapper = document.getElementById('localaddress-wrapper');
        const localInputs = localWrapper ? localWrapper.querySelectorAll('input, select') : [];
        const domiciliationsirenWrapper = document.getElementById('domiciliationsiren-wrapper');
        const domiciliationsirenInput = document.getElementById('domiciliationsiren');
        const domiciliationnameInput = document.getElementById('domiciliationname');

        const handleLMNP = () => {
            let lmnpOption = domiciliationSelect.querySelector('option[value="lmnp"]');
            if (formOfActivitySelect.value === 'location_biens') {
                if (!lmnpOption) {
                    lmnpOption = document.createElement('option');
                    lmnpOption.value = 'lmnp';
                    lmnpOption.textContent = 'à l’adresse du bien loué (LMNP)';
                    domiciliationSelect.appendChild(lmnpOption);
                }
                domiciliationSelect.value = 'lmnp';
                domiciliationSelect.disabled = true;
            } else {
                domiciliationSelect.disabled = false;
                if (lmnpOption) lmnpOption.remove();
            }
        };

        const handleAddress = () => {
            const needsAddress = domiciliationSelect.value !== 'personnel' && domiciliationSelect.value !== '';
            if (needsAddress) {
                localWrapper.classList.remove('hidden');
                localInputs.forEach(el => {
                    if (el.dataset.optional !== 'true') el.required = true;
                });
            } else {
                localWrapper.classList.add('hidden');
                localInputs.forEach(el => el.required = false);
            }
        };

        const handleDomiciliationCenter = () => {
            if (domiciliationSelect.value === 'domiciliation') {
                domiciliationsirenWrapper.classList.remove('hidden');
                domiciliationsirenInput.required = true;
                domiciliationnameInput.required = true;
            } else {
                domiciliationsirenWrapper.classList.add('hidden');
                domiciliationsirenInput.required = false;
                domiciliationnameInput.required = false;
            }
        };
        if (domiciliationsirenInput)
            domiciliationsirenInput.addEventListener('input', e => { e.target.value = e.target.value.replace(/\D/g, '').slice(0, 9); });

        /*** ACTIVITÉS SECONDAIRES ***/
        const nbrofactivitiesWrapper = document.getElementById('nbrofactivities-wrapper');
        const nbrofactivitiesInput = document.getElementById('nbrofactivies');
        const container = document.getElementById('secondary-activities-container');
        const template = document.getElementById('secondary-activity-template');

        const handleAddActivity = () => {
            if (!nbrofactivitiesWrapper || !nbrofactivitiesInput) return;

            const isSecondaryAllowed = domiciliationSelect.value !== 'lmnp' && domiciliationSelect.value !== '';

            if (!isSecondaryAllowed) {
                nbrofactivitiesWrapper.classList.add('hidden');
                nbrofactivitiesInput.required = false;
                nbrofactivitiesInput.value = '';
                container.innerHTML = '';
                return;
            }

            nbrofactivitiesWrapper.classList.remove('hidden');
            nbrofactivitiesInput.required = true;
            if (!nbrofactivitiesInput.value) nbrofactivitiesInput.value = 0;

            renderSecondaryActivities();
        };

        const renderSecondaryActivities = () => {
            const count = Number(nbrofactivitiesInput.value) || 0;
            container.innerHTML = '';

            if (count === 0) return;

            for (let i = 0; i < count; i++) {
                const clone = template.content.cloneNode(true);
                const textarea = clone.querySelector('textarea');
                textarea.name = `secondaryActivities[${i}][description]`;
                textarea.id = `secondaryActivities_${i}_description`;
                const select = clone.querySelector('select');
                select.name = `secondaryActivities[${i}][form]`;
                select.id = `secondaryActivities_${i}_form`;
                container.appendChild(clone);
            }
        };

        nbrofactivitiesInput.addEventListener('input', () => {
            let value = parseInt(nbrofactivitiesInput.value.replace(/\D/g, ''), 10);
            if (isNaN(value)) { nbrofactivitiesInput.value = ''; return; }
            if (value < 0) value = 0;
            if (value > 5) value = 5;
            nbrofactivitiesInput.value = value;
            renderSecondaryActivities();
        });
        nbrofactivitiesInput.addEventListener('change', renderSecondaryActivities);

        /*** SYNCHRONISATION FORMULAIRE ***/
        const syncForm = () => {
            handleLMNP();
            handleAddress();
            handleDomiciliationCenter();
            handleAddActivity();
        };
        formOfActivitySelect.addEventListener('change', syncForm);
        domiciliationSelect.addEventListener('change', syncForm);

        // INIT
        syncForm();
    });
</script>

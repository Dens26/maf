---
import Stepper from '@components/forms/Stepper.astro';
import { getBackgroundColor, getPaddingClass } from '@utils/styleUtils';
import Button from '@components/ui/Button.astro';
import type { ThemeColor, PaddingSize } from '@utils/styleUtils';

export interface Props {
    background?: ThemeColor;
    padding?: PaddingSize;
    paddingTop?: PaddingSize;
    paddingBottom?: PaddingSize;
}

const { background = 'base', padding, paddingTop, paddingBottom } = Astro.props;
const bgColor = getBackgroundColor(background);
const paddingClass = getPaddingClass({ padding, paddingTop, paddingBottom });
---

<section class:list={[bgColor, paddingClass]}>
    <div class="site-container px-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div>
                <Stepper currentStep={3} id="stepper" />
            </div>

            <div class="md:col-span-2">
                <h3 class="text-xl-2 font-semibold mb-4">Récapitulatif de vos informations</h3>

                <form id="recap-form">
                    <div id="recap-container" class="space-y-4 text-small mb-4"></div>

                    <div class="mb-4">
                        <label class="flex items-center space-x-2">
                            <input
                                type="checkbox"
                                id="certify"
                                required
                                class="w-4 h-4 text-primary border-gray-300 rounded"
                            />
                            <span class="text-sm text-gray-700"
                                >Je certifie que les informations fournies sont exactes et accepte que ma demande soit
                                transmise pour traitement.</span
                            >
                        </label>
                    </div>

                    <div class="flex justify-between my-8">
                        <Button href="/forms/create/business" variant="primary" size="md" class="uppercase"
                            >Étape précédente</Button
                        >
                        <Button type="submit" variant="primary" size="md" class="uppercase" id="submit-formality"
                            >Envoyer</Button
                        >
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script type="module">
    import { generateRecapPdf } from '/src/utils/generateRecapPdf.js';

    document.addEventListener('DOMContentLoaded', async () => {
        /* CONFIG */

        const STORAGE_KEY_ENTREPRENEUR = 'create-entrepreneur-form';
        const STORAGE_KEY_BUSINESS = 'create-business-form';

        const recapContainer = document.getElementById('recap-container');
        const form = document.getElementById('recap-form');

        if (!recapContainer || !form) return;

        const countries = await fetch('/data/countries.json').then((r) => r.json());

        const entrepreneur = JSON.parse(localStorage.getItem(STORAGE_KEY_ENTREPRENEUR) || '{}');
        const business = JSON.parse(localStorage.getItem(STORAGE_KEY_BUSINESS) || '{}');

        /* HELPERS */

        const formatCountry = (code) => {
            if (!code) return '-';
            const c = countries.find((x) => x.code === code);
            return c ? c.name : code;
        };

        const formatNationality = (code) => {
            if (!code) return '-';
            const c = countries.find((x) => x.code === code);
            return c ? c.nationality || c.name : code;
        };

        const capitalizeWords = (v = '') =>
            v
                .toLowerCase()
                .split(' ')
                .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
                .join(' ');

        const formatDateFR = (dateStr) => {
            if (!dateStr) return '-';
            const [y, m, d] = dateStr.split('-');
            return `${d}/${m}/${y}`;
        };

        const createLine = (label, values) => `
        <div class="flex justify-between border-b border-gray-200 py-1">
            <span class="font-medium">${label}</span>
            <span class="text-gray-600 text-right">${Array.isArray(values) ? values.filter(Boolean).join('<br>') : values || '-'}</span>
        </div>
        `;

        const createSection = (title, rows) => {
            const section = document.createElement('div');
            section.className = 'bg-white rounded-sm p-4 shadow-xs';

            section.innerHTML = `
            <h3 class="text-lg font-semibold mb-4">${title}</h3>
            <div class="space-y-1">${rows.join('')}</div>
            `;

            return section;
        };

        /* DISPLAY RECAP */

        const displayRecap = () => {
            recapContainer.innerHTML = '';

            const addressParts = [
                `${entrepreneur.tracknumber || ''} ${entrepreneur.complementnumber || ''} ${entrepreneur.tracktype || ''} ${entrepreneur.way || ''} ${entrepreneur.additionaladdress || ''}`.trim(),
                `${entrepreneur.zipcode || ''} ${entrepreneur.city || ''} ${formatCountry(entrepreneur.country) || ''}`.trim(),
            ];

            // ---------------- ENTREPRENEUR ----------------
            if (Object.keys(entrepreneur).length) {
                // INFORMATIONS PERSONELLES
                const rows = [
                    createLine('Genre', capitalizeWords(entrepreneur.gender)),
                    createLine('Nom de naissance', (entrepreneur.birthname || '').toUpperCase()),
                ];
                if (entrepreneur.name) rows.push(createLine("Nom d'usage", (entrepreneur.name || '').toUpperCase()));

                rows.push(
                    createLine('Prénom', capitalizeWords(entrepreneur.firstname)),
                    createLine('Email', entrepreneur.email),
                    createLine('Téléphone', entrepreneur.phone),
                    createLine('Adresse', addressParts),
                    createLine('Date de naissance', formatDateFR(entrepreneur.birthdate)),
                    createLine('Pays de naissance', formatCountry(entrepreneur.birthcountry)),
                    createLine('Ville de naissance', capitalizeWords(entrepreneur.birthcity)),
                    createLine('Département de naissance', entrepreneur.birthdepartment),
                    createLine('Nationalité', formatNationality(entrepreneur.nationality)),
                    createLine(
                        'Assurance santé',
                        entrepreneur.insuranceorganization === 'Autre'
                            ? entrepreneur.otherhealthinsurance
                            : entrepreneur.insuranceorganization,
                    ),
                );

                if (entrepreneur.healthinsurance)
                    rows.push(createLine('N° Sécurité sociale', entrepreneur.healthinsurance));

                rows.push(
                    createLine('Situation', entrepreneur.situation),
                    createLine(
                        'Profession actuelle',
                        business.otheractivity === 'Autre'
                            ? business.otheractivitydetail || '-'
                            : business.otheractivity,
                    ),
                );
                recapContainer.appendChild(createSection('Informations personnelles', rows));

                // INFO CONJOINT
                if (entrepreneur.partnerbirthname) {
                    const partnerAddress = [
                        `${entrepreneur.partnertracknumber || ''} ${entrepreneur.partnercomplementnumber || ''} ${entrepreneur.partnertracktype || ''} ${entrepreneur.partnerway || ''} ${entrepreneur.partneradditionaladdress || ''}`.trim(),
                        `${entrepreneur.partnerzipcode || ''} ${entrepreneur.partnercity || ''} ${formatCountry(entrepreneur.partnercountry) || ''}`.trim(),
                    ];
                    const rows = [
                        createLine('Genre', capitalizeWords(entrepreneur.partnergender)),
                        createLine('Nom de naissance', (entrepreneur.partnerbirthname || '').toUpperCase()),
                    ];

                    if (entrepreneur.partnername)
                        rows.push(createLine("Nom d'usage", (entrepreneur.partnername || '').toUpperCase()));

                    rows.push(
                        createLine('Prénom', capitalizeWords(entrepreneur.partnerfirstname)),
                        createLine('Fonction', capitalizeWords(entrepreneur.partnerfonction)),
                    );

                    if (entrepreneur.partnerfonction != 'Aucun') {
                        rows.push(
                            createLine('Date de naissance', formatDateFR(entrepreneur.partnerbirthdate)),
                            createLine('Pays de naissance', formatCountry(entrepreneur.partnerbirthcountry)),
                            createLine('Nationalité', formatNationality(entrepreneur.partnernationality)),
                        );
                    }
                    if (entrepreneur.partneraddress === 'non') rows.push(createLine('Adresse', partnerAddress));
                    else rows.push(createLine('Adresse', addressParts));
                    recapContainer.appendChild(createSection('Informations du conjoint', rows));
                }
            }

            // ---------------- BUSINESS ----------------
            if (Object.keys(business).length) {
                const businessAddress = `${business.tracknumber || ''} ${business.complementnumber || ''} ${business.tracktype || ''} ${business.way || ''}, ${business.zipcode || ''} ${business.city || ''}`;

                let rows = [];
                // INFORMATION SUR L'ANCIENNE ACTIVITE DEJA EXERCEE
                if (business.previousselfemployedactivity === 'oui') {
                    rows = [
                        createLine("Pays de l'activité déjà exercée", formatCountry(business.sirencountry)),
                        createLine("Date de fin de l'activité déjà exercée", formatDateFR(business.oldactivitydate)),
                        createLine("Description de l'activité déjà exercée", business.oldactivity),
                    ];
                }
                if (business.sirencountry === 'FR')
                    rows.push(createLine("Siren d'activité déjà exercée", business.siren));
                if (business.previousselfemployedactivity === 'oui')
                    recapContainer.appendChild(createSection('Activité déjà exercée', rows));

                // INFORMATION DE L'ENTREPRISE
                rows = [createLine('Micro-entreprise', business.micro)];

                rows.push(
                    createLine('Déclaration URSSAF', business.insuranceorganization),
                    createLine("Contrat d'appui", business.supportcontract),
                    createLine("Demande d'ACCRE", business.accre),
                );
                if (business.domiciliationname)
                    rows.push(createLine('Organisme de domiciliation', business.domiciliationname));
                if (business.domiciliationsiren)
                    rows.push(createLine('Siren de domiciliation', business.domiciliationsiren));
                recapContainer.appendChild(createSection("Informations de l'entreprise à créer", rows));

                // ACTIVITES DE L'ENTREPRISE
                rows = [
                    createLine("Description de l'activité", business.activity),
                    createLine("Forme de l'activité", business.formofactivity),
                ];

                if (business.businessname) rows.push(createLine('Nom commercial', business.businessname));

                if (business.way) rows.push(createLine("Adresse de l'établissement", businessAddress));
                else rows.push(createLine("Adresse de l'établissement", addressParts));

                recapContainer.appendChild(createSection("Informations de l'activité de l'entreprise à créer", rows));

                // ACTIVITÉS SECONDAIRES
                const secondary = [];
                const n = parseInt(business.nbrofactivies || 0);

                for (let i = 0; i < n; i++) {
                    const desc = business[`secondaryActivities[${i}][description]`];
                    const form = business[`secondaryActivities[${i}][form]`];

                    if (desc) secondary.push({ desc, form });
                }

                if (secondary.length) {
                    const section = document.createElement('div');
                    section.className = 'bg-white rounded-sm p-4 shadow-xs';

                    section.innerHTML = `
                    <h3 class="text-lg font-semibold mb-4">Activités secondaires</h3>
                    <div class="space-y-4">
                        ${secondary
                            .map(
                                (a) => `
                        <div class="border border-gray-400 bg-gray-50 rounded-sm overflow-hidden">
                            
                            <!-- Description -->
                            <div class="p-3 text-sm bg-white">
                                <p class="font-semibold mb-1">Description de l'activité</p>
                                <p class="text-gray-700 whitespace-pre-line leading-relaxed">${a.desc}</p>
                            </div>

                            <!-- Séparateur -->
                            <div class="border-t border-gray-300"></div>

                            <!-- Forme -->
                            <div class="px-3 py-2 font-medium text-sm bg-gray-100 text-gray-700">
                                Forme de l’activité : <span class="text-gray-600">${a.form}</span>
                            </div>

                            </div>
                        `,
                            )
                            .join('')}
                    </div>
                    `;
                    recapContainer.appendChild(section);
                }
            }
            // OBSERVATION
            if (business.observation != '') {
                const rows = [createLine('Précision utile à votre demande', business.observation)];
                recapContainer.appendChild(createSection('Information complémentaire', rows));
            }
        };

        displayRecap();

        /* SUBMIT → GENERATE PDF */

        console.log(business);
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Génération du PDF...';

            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Génération du PDF...';

                const pdfBlob = generateRecapPdf(recapContainer, { download: false });

                if (!(pdfBlob instanceof Blob) || pdfBlob.size === 0)
                    throw new Error('Le PDF généré est vide ou invalide.');

                // Convertir en base64 pour stockage temporaire
                const reader = new FileReader();

                reader.onloadend = () => {
                    sessionStorage.setItem('generatedPdf', reader.result);
                };

                reader.readAsDataURL(pdfBlob);

                submitBtn.textContent = 'Envoi en cours...';

                // Gestion de la création
                const formData = new FormData();
                formData.append('typeFormaliteId', '1');
                formData.append('name', entrepreneur.name);
                formData.append('siren', business.siren);
                formData.append('email', entrepreneur.email);
                formData.append('phone', entrepreneur.phone);
                formData.append('city', entrepreneur.city);
                formData.append('zipcode', entrepreneur.zipcode);
                formData.append('pdf', pdfBlob, 'recap.pdf');

                const response = await fetch('/api/create', {
                    method: 'POST',
                    body: formData,
                });
                const data = await response.json();

                console.log(response.status)
                if (!response.ok) {
                    if (response.status === 500) {
                        window.location.href = '/serveur_indisponible';
                        return;
                    }
                    if (response.status === 400) {
                        window.location.href = `/doublon?statut=${data.statut}`;
                        return;
                    }
                    throw new Error(data.error || 'Erreur lors de l’envoi');
                }

                // ✅ Succès total
                submitBtn.textContent = 'Envoyé ✔';
                // localStorage.clear();

                window.location.href = `/confirmation?token=${data.token}`;
            } catch (e) {
                window.location.href = '/serveur_indisponible';
            }
        });
    });
</script>

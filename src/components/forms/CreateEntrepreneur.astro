---
import Button from '@components/ui/Button.astro';
import Input from '@components/ui/form/Input.astro';
import Date from '@components/ui/form/Date.astro';
import Select from '@components/ui/form/Select.astro';
import Radio from '@components/ui/form/Radio.astro';
import countries from 'public/data/countries.json';
import departments from 'public/data/departments.json';

const genderOptions = [
  { label: 'M.', value: 'monsieur' },
  { label: 'Mme', value: 'madame' },
];

const complementnumberOptions = [
  { label: '', value: '' },
  { label: 'Bis', value: 'bis' },
  { label: 'Ter', value: 'ter' },
  { label: 'Quater', value: 'quater' },
  { label: 'Quinquies', value: 'quinquies' },
  { label: 'Sexies', value: 'sexies' },
  { label: 'Septies', value: 'septies' },
  { label: 'Octies', value: 'octies' },
  { label: 'Nonies', value: 'nonies' }
];

const tracktypeOptions = [
  { label: "AllÃ©e", value: "AllÃ©e" },
  { label: "AllÃ©e privÃ©e", value: "AllÃ©e privÃ©e" },
  { label: "Avenue", value: "Avenue" },
  { label: "Boulevard", value: "Boulevard" },
  { label: "Boulevard pÃ©riphÃ©rique", value: "Boulevard pÃ©riphÃ©rique" },
  { label: "CitÃ©", value: "CitÃ©" },
  { label: "Cour", value: "Cour" },
  { label: "Chemin", value: "Chemin" },
  { label: "Chemin rural", value: "Chemin rural" },
  { label: "Impasse", value: "Impasse" },
  { label: "Lotissement", value: "Lotissement" },
  { label: "Parc", value: "Parc" },
  { label: "Passage", value: "Passage" },
  { label: "Place", value: "Place" },
  { label: "Place de laâ€¦", value: "Place de laâ€¦" },
  { label: "Promenade", value: "Promenade" },
  { label: "Quai", value: "Quai" },
  { label: "Route", value: "Route" },
  { label: "Route dÃ©partementale", value: "Route dÃ©partementale" },
  { label: "Route nationale", value: "Route nationale" },
  { label: "Ruelle", value: "Ruelle" },
  { label: "RÃ©sidence", value: "RÃ©sidence" },
  { label: "Sentier", value: "Sentier" },
  { label: "Villa", value: "Villa" },
  { label: "Voie", value: "Voie" },
  { label: "Zone industrielle", value: "Zone industrielle" }
];

const insuranceorganizationOptions = [
  { label: "Agricole", value: "Agricole" },
  { label: "ENIM", value: "ENIM" },
  { label: "Non salariÃ© non Agricole", value: "Non salariÃ© non Agricole" },
  { label: "RÃ©gime gÃ©nÃ©ral", value: "RÃ©gime gÃ©nÃ©ral" },
  { label: "Autre", value: "Autre" }
];

const situationOptions = [
  { label: "CÃ©libataire", value: "CÃ©libataire" },
  { label: "DivorcÃ©", value: "DivorcÃ©" },
  { label: "En concubinage", value: "Concubinage" },
  { label: "MariÃ©", value: "MariÃ©" },
  { label: "PacsÃ©", value: "PacsÃ©" },
  { label: "Veuf", value: "Veuf" }
];

const partnerFonctionOptions = [
  { label: "Aucun", value: "Aucun" },
  { label: "Collaborateur", value: "Collaborateur" },
  { label: "SalariÃ©", value: "SalariÃ©" }
];

const partnerAddressOptions = [
    { label: 'Oui', value: 'oui' },
    { label: 'Non', value: 'non' },
];

const countryOptions = [
  { label: "France", value: "FR" },
  ...countries
    .filter(c => c.name !== "France")
    .sort((a, b) => a.name.localeCompare(b.name))
    .map(c => ({ label: c.name, value: c.code }))
];

const nationalityOptions = [
  { label: "FranÃ§aise", value: "FR" },
  ...countries
    .filter(c => c.nationality !== "FranÃ§aise")
    .sort((a, b) => a.nationality.localeCompare(b.nationality))
    .map(c => ({ label: c.nationality, value: c.code }))
];

const departmentOptions = departments
  .sort((a, b) => a.code.localeCompare(b.code))
  .map(dep => ({ 
    label: `${dep.code} - ${dep.dep_name}`, 
    value: dep.code 
  }));

const formBackground = 'light';
---

<div>
  <h3 class="text-xl-2 font-semibold mb-4">Informations personnelles</h3>
</div>

<form id="create-form" action="/forms/create/business">

  <!-- Contact -->
  <div class="space-y-2 md:space-y-4 bg-white p-2 rounded-sm mb-4">
    <div class="text-md font-semibold">Contact</div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
      <Input label="Adresse e-mail" id="email" name="email" required background={formBackground} class="lowercase" autocomplete="email" />
      <Input label="TÃ©lÃ©phone" id="phone" name="phone" required background={formBackground} autocomplete="tel" />
    </div>
  </div>

  <!-- Entrepreneur -->
  <div class="space-y-2 sm:space-y-4 bg-white p-2 sm:p-4 rounded-sm mb-4">
    <div class="text-md font-semibold">Entrepreneur</div>

    <!-- Genre / Nom / PrÃ©nom -->
    <div class="grid grid-cols-5 gap-2 sm:gap-4">
      <Select label="Genre" id="gender" name="gender" options={genderOptions} required background={formBackground} class="col-span-1" autocomplete="sex" />
      <div class="col-span-4 flex gap-2 sm:gap-4">
        <Input label="Nom naissance" id="birthname" name="birthname" required background={formBackground} class="uppercase" autocomplete="family-name" />
        <Input label="PrÃ©nom" id="firstname" name="firstname" required background={formBackground} class="capitalize" autocomplete="given-name" />
      </div>
    </div>

    <!-- Nom d'usage / Date / Pays / DÃ©partement / Ville / NationalitÃ© / Situation -->
    <div class="flex flex-wrap gap-2 sm:gap-4">
      <div class="flex-1 min-w-[48%]"><Input label="Nom d'usage" id="name" name="name" background={formBackground} class="uppercase" autocomplete="family-name" /></div>
      <div class="flex-1 min-w-[48%]"><Select label="Pays de naissance" id="birthcountry" name="birthcountry" options={countryOptions} required background={formBackground} autocomplete="country-of-birth" /></div>
      <div class="flex-1 min-w-[48%]"><Date label="Date de naissance" id="birthdate" name="birthdate" required background={formBackground} autocomplete="bday" /></div>
      <div class="flex-1 min-w-[48%]"><Input label="Ville de naissance" id="birthcity" name="birthcity" required background={formBackground} class="capitalize" autocomplete="address-level2" /></div>
      <div id="birthdepartment-wrapper" class="hidden transition-all duration-300 flex-1 min-w-[48%]">
        <Select label="DÃ©pt. de naissance" id="birthdepartment" name="birthdepartment" options={departmentOptions} required background={formBackground} />
      </div>
      <div class="flex-1 min-w-[48%]"><Select label="NationalitÃ©" id="nationality" name="nationality" options={nationalityOptions} required background={formBackground} autocomplete="nationality" /></div>
      <div class="flex-1 min-w-[48%]"><Select label="Situation familiale" id="situation" name="situation" options={situationOptions} required background={formBackground} /></div>
    </div>
  </div>

  <!-- Adresse de l'entrepreneur -->
  <div class="space-y-2 sm:space-y-4 bg-white p-2 sm:p-4 rounded-sm mb-4">
    <div class="text-md font-semibold">Adresse de l'entrepreneur</div>
    <div class="grid grid-cols-12 gap-2 sm:gap-4">
      <div class="col-span-2"><Input label="NÂ°" id="tracknumber" name="tracknumber" required background={formBackground} autocomplete="street-address" /></div>
      <div class="col-span-3"><Select label="Indice" id="complementnumber" name="complementnumber" options={complementnumberOptions} data-optional="true" background={formBackground} /></div>
      <div class="col-span-7"><Select label="Type de voie" id="tracktype" name="tracktype" options={tracktypeOptions} required background={formBackground} /></div>
    </div>
    <Input label="Nom de la voie" id="way" name="way" required background={formBackground} autocomplete="street-address"/>
    <div class="grid grid-cols-2 gap-2 sm:gap-4">
      <Input label="Code postal" id="zipcode" name="zipcode" required background={formBackground} autocomplete="postal-code" />
      <Input label="Ville" id="city" name="city" required background={formBackground} class="capitalize" autocomplete="address-level2"/>
    </div>
    <div class="grid grid-cols-2 gap-2 sm:gap-4">
      <Input label="ComplÃ©ment" id="additionaladdress" name="additionaladdress" data-optional="true" background={formBackground} autocomplete="address-line2"/>
      <Select label="Pays" id="country" name="country" options={countryOptions} required background={formBackground} autocomplete="country" />
    </div>
  </div>

  <!-- Protection sociale -->
  <div class="space-y-2 sm:space-y-4 bg-white p-2 sm:p-4 rounded-sm mb-4">
    <div class="text-md font-semibold">Protection sociale</div>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-4">
      <Select label="Organisme d'assurance" id="insuranceorganization" name="insuranceorganization" options={insuranceorganizationOptions} required background={formBackground}/>
      <div id="otherhealthinsurance-wrapper" class="hidden transition-all duration-300">
        <Input label="Autre organisme d'assurance" id="otherhealthinsurance" name="otherhealthinsurance" required background={formBackground} />
      </div>
      <div id="healthinsurance-wrapper" class="hidden transition-all duration-300">
        <Input label="NÂ° SÃ©curitÃ© sociale" id="healthinsurance" name="healthinsurance" required background={formBackground} autocomplete="ssn" />
      </div>
    </div>
  </div>

  <!-- Conjoint -->
  <div id="partner-wrapper" class="space-y-2 sm:space-y-4 bg-white p-2 sm:p-4 rounded-sm mb-4 hidden transition-all duration-300">
    <div class="text-md font-semibold">Conjoint</div>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-4">
      <Select label="RÃ´le du conjoint dans l'entreprise" id="partnerfonction" name="partnerfonction" options={partnerFonctionOptions} required background={formBackground} />
    </div>
    <div id="partnerinfo-wrapper">
      <div class="grid grid-cols-5 gap-2 sm:gap-4 mb-4">
        <Select label="Genre" id="partnergender" name="partnergender" options={genderOptions} required background={formBackground} class="col-span-1" autocomplete="sex" />
        <div class="col-span-4 flex gap-2 sm:gap-4">
          <Input label="Nom de naissance" id="partnerbirthname" name="partnerbirthname" required background={formBackground} class="uppercase flex-1" autocomplete="family-name" />
          <Input label="PrÃ©nom" id="partnerfirstname" name="partnerfirstname" required background={formBackground} class="capitalize flex-1" autocomplete="given-name" />
        </div>
      </div>

      <div class="flex flex-wrap gap-2 sm:gap-4">
        <div class="flex-1 min-w-[48%]"><Input label="Nom d'usage" id="partnername" name="partnername" background={formBackground} class="uppercase" autocomplete="family-name" /></div>
        <div class="flex-1 min-w-[48%]"><Date label="Date de naissance" id="partnerbirthdate" name="partnerbirthdate" required background={formBackground} autocomplete="bday" /></div>
        <div class="flex-1 min-w-[48%]"><Select label="Pays de naissance" id="partnerbirthcountry" name="partnerbirthcountry" options={countryOptions} required background={formBackground} autocomplete="country-of-birth" /></div>
        <div class="flex-1 min-w-[48%]"><Select label="NationalitÃ©" id="partnernationality" name="partnernationality" options={nationalityOptions} required background={formBackground} autocomplete="nationality" /></div>
        <div class="flex-1 min-w-[48%]"><Radio label="Le conjoint rÃ©side-t-il Ã  la mÃªme adresse que lâ€™entrepreneur ?" id="partneraddress" name="partneraddress" options={partnerAddressOptions} required background={formBackground} /></div>
      </div>
    </div>
  </div>

  <!-- Adresse du conjoint -->
  <div id="partneraddress-wrapper" class="space-y-2 sm:space-y-4 bg-white p-2 sm:p-4 rounded-sm mb-4 hidden transition-all duration-300">
    <div class="text-md font-semibold">Adresse du conjoint</div>
    <div class="grid grid-cols-12 gap-2 sm:gap-4">
      <div class="col-span-2"><Input label="NÂ°" id="partnertracknumber" name="partnertracknumber" required background={formBackground} autocomplete="street-address" /></div>
      <div class="col-span-3"><Select label="Indice" id="partnercomplementnumber" name="partnercomplementnumber" options={complementnumberOptions} data-optional="true" placeholder='' background={formBackground} /></div>
      <div class="col-span-7"><Select label="Type de voie" id="partnertracktype" name="partnertracktype" options={tracktypeOptions} required background={formBackground} /></div>
    </div>
    <Input label="Nom de la voie" id="partnerway" name="partnerway" required background={formBackground} autocomplete="street-address"/>
    <div class="grid grid-cols-2 gap-2 sm:gap-4">
      <Input label="ComplÃ©ment" id="partneradditionaladdress" name="partneradditionaladdress" data-optional="true" background={formBackground} autocomplete="address-line2"/>
      <Select label="Pays" id="partnercountry" name="partnercountry" options={countryOptions} required background={formBackground} autocomplete="country" />
    </div>
    <div class="grid grid-cols-2 gap-2 sm:gap-4">
      <Input label="Code postal" id="partnerzipcode" name="partnerzipcode" required background={formBackground} autocomplete="postal-code" />
      <Input label="Ville" id="partnercity" name="partnercity" required background={formBackground} class="capitalize" autocomplete="address-level2"/>
    </div>
  </div>

  <div class="text-end my-8">
    <Button type="submit" variant="primary" size="md" class='uppercase'>Ã©tape suivante</Button>
  </div>
</form>


<!-- SCRIPT JS -->
<script type="module">
document.addEventListener('DOMContentLoaded', () => {
  
  const form = document.getElementById('create-form');
  if (!form) return;

  const STORAGE_KEY = 'create-entrepreneur-form';

  /* ===================== HELPERS ===================== */

  const setRequired = (elements, required) => {
    elements.forEach(el => {
      if (!el) return;
      required ? el.setAttribute('required', '') : el.removeAttribute('required');
    });
  };

  const resetValues = elements => {
    elements.forEach(el => {
      if (!el) return;
      if (el.type === 'radio' || el.type === 'checkbox') {
        el.checked = false;
      } else {
        el.value = '';
      }
    });
  };

  /* ===================== FIELDS ===================== */

  const countrySelect = form.querySelector('select[name="birthcountry"]');
  const departmentWrapper = document.getElementById('birthdepartment-wrapper');
  const departmentInput = document.getElementById('birthdepartment');
  const country = document.getElementById('country');
  const zipCode = document.getElementById('zipcode');

  const nationalitySelect = form.querySelector('select[name="nationality"]');
  const healthInsuranceWrapper = document.getElementById('healthinsurance-wrapper');
  const healthInsuranceInput = document.getElementById('healthinsurance');

  const insuranceSelect = form.querySelector('select[name="insuranceorganization"]');
  const otherInsuranceWrapper = document.getElementById('otherhealthinsurance-wrapper');
  const otherInsuranceInput = document.getElementById('otherhealthinsurance');

  const situationSelect = form.querySelector('select[name="situation"]');
  const partnerWrapper = document.getElementById('partner-wrapper');
  const partnerCountry = document.getElementById('partnercountry');
  const partnerZipCode = document.getElementById('partnerzipcode');

  const partnerFonctionSelect = form.querySelector('select[name="partnerfonction"]');
  const partnerInfoWrapper = document.getElementById('partnerinfo-wrapper');

  const partnerAddressWrapper = document.getElementById('partneraddress-wrapper');

  const partnerAddressRadios = [
    ...form.querySelectorAll('input[name="partneraddress"]')
  ];

  /* ===================== PARTNER FIELDS ===================== */

  const partnerFields = {
    inputs: [
      document.getElementById('partnerbirthname'),
      document.getElementById('partnerfirstname'),
      document.getElementById('partnername'),
      document.getElementById('partnerbirthdate'),
    ],
    selects: [
      ...form.querySelectorAll('select[name="partnergender"]'),
      ...form.querySelectorAll('select[name="partnerbirthcountry"]'),
      ...form.querySelectorAll('select[name="partnerbirthdepartment"]'),
      ...form.querySelectorAll('select[name="partnernationality"]'),
    ]
  };

  const partnerAddressFields = {
    inputs: [
      document.getElementById('partnertracknumber'),
      document.getElementById('partnerway'),
      document.getElementById('partnerzipcode'),
      document.getElementById('partnercity'),
      document.getElementById('partneradditionaladdress'),
    ],
    selects: [
      ...form.querySelectorAll('select[name="partnertracktype"]'),
      ...form.querySelectorAll('select[name="partnercountry"]'),
      ...form.querySelectorAll('select[name="partnercomplementnumber"]')
    ]
  };

  /* ===================== STORAGE ===================== */

  const saveForm = () => {
    const data = {};
    new FormData(form).forEach((value, key) => (data[key] = value));
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  };

  const restoreForm = () => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) return;

    const data = JSON.parse(saved);
    Object.entries(data).forEach(([name, value]) => {
      const fields = form.querySelectorAll(`[name="${name}"]`);
      fields.forEach(field => {
        if (field.type === 'radio') {
          field.checked = field.value === value;
        } else {
          field.value = value;
        }
      });
    });
  };

  restoreForm();
  form.addEventListener('input', saveForm);
  form.addEventListener('change', saveForm);

  /* ===================== RESET PARTNER ===================== */

  const resetPartner = () => {
    resetValues([...partnerFields.inputs, ...partnerFields.selects]);
    resetValues([...partnerAddressFields.inputs, ...partnerAddressFields.selects]);

    setRequired(
      [...partnerFields.inputs, ...partnerFields.selects],
      false
    );

    setRequired(
      [...partnerAddressFields.inputs, ...partnerAddressFields.selects],
      false
    );

    partnerAddressRadios.forEach(r => {
      r.checked = r.value === 'oui';
    });

    partnerAddressWrapper.classList.add('hidden', 'opacity-0');
    partnerAddressWrapper.classList.remove('opacity-100');
  };

  /* ===================== TOGGLES ===================== */

  const toggleDepartment = () => {
    const isFrance = countrySelect.value === 'FR';

    departmentWrapper.classList.toggle('hidden', !isFrance);
    departmentWrapper.classList.toggle('opacity-100', isFrance);
    departmentWrapper.classList.toggle('opacity-0', !isFrance);

    isFrance
      ? departmentInput.setAttribute('required', '')
      : (departmentInput.removeAttribute('required'), departmentInput.value = '');
  };

  const toggleHealthInsurance = () => {
    const isFrench = nationalitySelect.value === 'FR';

    healthInsuranceWrapper.classList.toggle('hidden', !isFrench);
    healthInsuranceWrapper.classList.toggle('opacity-100', isFrench);
    healthInsuranceWrapper.classList.toggle('opacity-0', !isFrench);

    isFrench
      ? healthInsuranceInput.setAttribute('required', '')
      : (healthInsuranceInput.removeAttribute('required'), healthInsuranceInput.value = '');
  };

  const toggleOtherInsurance = () => {
    const isOther = insuranceSelect.value === 'Autre';

    otherInsuranceWrapper.classList.toggle('hidden', !isOther);
    otherInsuranceWrapper.classList.toggle('opacity-100', isOther);
    otherInsuranceWrapper.classList.toggle('opacity-0', !isOther);

    isOther
      ? otherInsuranceInput.setAttribute('required', '')
      : (otherInsuranceInput.removeAttribute('required'), otherInsuranceInput.value = '');
  };

  const togglePartnerAddress = () => {
    const showAddress = partnerAddressRadios.find(r => r.checked)?.value === 'non';

    partnerAddressWrapper.classList.toggle('hidden', !showAddress);
    partnerAddressWrapper.classList.toggle('opacity-0', !showAddress);
    partnerAddressWrapper.classList.toggle('opacity-100', showAddress);

    setRequired(
      [...partnerAddressFields.inputs, ...partnerAddressFields.selects].filter(el => el.id !== 'partneradditionaladdress' && el.id !== 'partnercomplementnumber'),
      showAddress
    );

    if (!showAddress) {
      resetValues([...partnerAddressFields.inputs, ...partnerAddressFields.selects]);
    }
  };

  const togglePartnerInfo = () => {
    const isAucun = partnerFonctionSelect.value === 'Aucun';

    partnerInfoWrapper.classList.toggle('hidden', isAucun);
    partnerInfoWrapper.classList.toggle('opacity-0', isAucun);
    partnerInfoWrapper.classList.toggle('opacity-100', !isAucun);

    setRequired(
      [...partnerFields.inputs, ...partnerFields.selects].filter(el => el.id !== 'partnername'),
      !isAucun
    );

    if (isAucun) resetPartner();
  };

  const togglePartner = () => {
    const showPartner = ['MariÃ©', 'PacsÃ©', 'Concubinage'].includes(situationSelect.value);

    partnerWrapper.classList.toggle('hidden', !showPartner);
    partnerWrapper.classList.toggle('opacity-0', !showPartner);
    partnerWrapper.classList.toggle('opacity-100', showPartner);

    if (!showPartner) {
      partnerFonctionSelect.value = 'Aucun';
      resetPartner();
      togglePartnerInfo(); // ðŸ”¥ SYNC VISUEL
      return;
    }

    // Quand on REVIENT sur MariÃ© / PacsÃ© / Concubinage
    togglePartnerInfo(); // ðŸ”¥ resynchronise l'affichage
  };

  /* ===================== EVENTS ===================== */

  // Quand on change le pays
  country.addEventListener('change', () => {
    if (zipCode)
      zipCode.value = '';
  });

  // Quand on change le pays partenaire
  partnerCountry.addEventListener('change', () => {
      if (partnerZipCode)
        partnerZipCode.value = '';
  });
  
  countrySelect.addEventListener('change', toggleDepartment);
  nationalitySelect.addEventListener('change', toggleHealthInsurance);
  insuranceSelect.addEventListener('change', toggleOtherInsurance);
  situationSelect.addEventListener('change', togglePartner);
  partnerFonctionSelect.addEventListener('change', togglePartnerInfo);
  partnerAddressRadios.forEach(r => r.addEventListener('change', togglePartnerAddress));

  /* ===================== FILTER INPUTS ===================== */

  document.addEventListener('input', e => {
    if (country.value === "FR" && e.target.name === "zipcode")
      e.target.value = e.target.value.replace(/\D/g, '').slice(0, 5);

    if (partnerCountry.value === "FR" && e.target.name === "partnerzipcode")
      e.target.value = e.target.value.replace(/\D/g, '').slice(0, 5);

    if (['tracknumber', 'partnertracknumber', 'phone'].includes(e.target.name))
      e.target.value = e.target.value.replace(/\D/g, '');

    if (e.target.name === "healthinsurance")
      e.target.value = e.target.value.replace(/\D/g, '').slice(0, 15);
  });

  /* ===================== INIT ===================== */

  toggleDepartment();
  toggleHealthInsurance();
  toggleOtherInsurance();
  togglePartner();
  togglePartnerInfo();
  togglePartnerAddress();
});
</script>


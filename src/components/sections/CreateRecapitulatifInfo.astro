---
import Stepper from '@components/forms/Stepper.astro';
import { getBackgroundColor, getPaddingClass } from '@utils/styleUtils';
import Button from '@components/ui/Button.astro';
import type { ThemeColor, PaddingSize } from '@utils/styleUtils';

export interface Props {
    background?: ThemeColor;
    padding?: PaddingSize;
    paddingTop?: PaddingSize;
    paddingBottom?: PaddingSize;
}

const { background = 'base', padding, paddingTop, paddingBottom } = Astro.props;
const bgColor = getBackgroundColor(background);
const paddingClass = getPaddingClass({ padding, paddingTop, paddingBottom });

---

<section class:list={[bgColor, paddingClass]}>
    <div class="site-container px-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div>
                <Stepper currentStep={3} id="stepper" />
            </div>
            <div class="md:col-span-2">
                <h2 class="text-xl-2 font-semibold mb-6">Récapitulatif de vos informations</h2>
                <div id="recap-container" class="space-y-6"></div>
                <div class="flex justify-between my-8">
                    <Button href="/forms/create/business" variant="primary" size="md" class="uppercase">Étape précédente</Button>
                    <Button variant="primary" size="md" class="uppercase" id="submit-formality">Envoyer ma formalité</Button>
                </div>
            </div>
        </div>
    </div>
</section>

<script type="module">
document.addEventListener('DOMContentLoaded', async () => {
    const STORAGE_KEY_ENTREPRENEUR = 'create-entrepreneur-form';
    const STORAGE_KEY_BUSINESS = 'create-business-form';
    const countries = await fetch('/data/countries.json').then(r => r.json());

    const formatCountry = (code) => {
        if (!code) return '-';
        const country = countries.find(c => c.code === code);
        return country ? country.name : code;
    };

    const formatNationality = (code) => {
        if (!code) return '-';
        const country = countries.find(c => c.code === code);
        return country ? country.nationality || country.name : code;
}   ;

    const recapContainer = document.getElementById('recap-container');
    const submitBtn = document.getElementById('submit-formality');
    if (!recapContainer || !submitBtn) return;

    const entrepreneur = JSON.parse(localStorage.getItem(STORAGE_KEY_ENTREPRENEUR) || '{}');
    const business = JSON.parse(localStorage.getItem(STORAGE_KEY_BUSINESS) || '{}');

    const capitalizeWords = v => (v || '').toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');

    const formatDateFR = (dateStr) => {
        if (!dateStr) return '-';
        const [y, m, d] = dateStr.split('-');
        return `${d}/${m}/${y}`;
    };

    const createLine = (label, values) => `
        <div class="flex justify-between py-2 border-b border-gray-200">
            <span class="text-gray-600">${label}</span>
            <span class="font-medium text-right">${Array.isArray(values) ? values.filter(v => v).join('<br>') : values || '-'}</span>
        </div>
        `;


    const createSection = (title, rows) => {
        const section = document.createElement('div');
        section.className = 'bg-white rounded-sm p-4 shadow-xs';

        section.innerHTML = `
            <h3 class="text-lg font-semibold mb-4">${title}</h3>
            <div class="space-y-1">
                ${rows.join('')}
            </div>
        `;

        return section;
    };

    const displayRecap = () => {
        recapContainer.innerHTML = '';
        const addressParts = [
            `${entrepreneur.tracknumber || ''} ${entrepreneur.complementnumber || ''} ${entrepreneur.tracktype || ''} ${entrepreneur.way || ''} ${entrepreneur.additionaladdress || ''}`.trim(),
            `${entrepreneur.zipcode || ''} ${entrepreneur.city || ''} ${formatCountry(entrepreneur.country) || ''}`.trim()
        ];

        // ---------------- ENTREPRENEUR ----------------
        if (Object.keys(entrepreneur).length) {

            // INFORMATIONS PERSONELLES
            const rows = [
                createLine('Genre', capitalizeWords(entrepreneur.gender)),
                createLine('Nom de naissance', (entrepreneur.birthname || '').toUpperCase()),
            ];

            if (entrepreneur.name)
                rows.push(createLine("Nom d'usage", (entrepreneur.name || '').toUpperCase()));

            rows.push(
                createLine('Prénom', capitalizeWords(entrepreneur.firstname)),
                createLine('Email', entrepreneur.email),
                createLine('Téléphone', entrepreneur.phone),
                createLine('Adresse', addressParts),
                createLine('Date de naissance', formatDateFR(entrepreneur.birthdate)),
                createLine('Pays de naissance', formatCountry(entrepreneur.birthcountry).toUpperCase()),
                createLine('Ville de naissance', capitalizeWords(entrepreneur.birthcity)),
                createLine('Département de naissance', formatCountry(entrepreneur.birthdepartment)),
                createLine('Nationalité', formatNationality(entrepreneur.nationality)),
                createLine('Assurance santé', entrepreneur.insuranceorganization === 'Autre' ? entrepreneur.otherhealthinsurance : entrepreneur.insuranceorganization),
                createLine("N° Sécurité sociale", entrepreneur.healthinsurance),
                createLine("Situation", entrepreneur.situation),
            );
            recapContainer.appendChild(createSection("Inormation personnelles", rows));

            // INFO CONJOINT
            if (entrepreneur.partnerbirthname) {
                const partnerAddress = [
                    `${entrepreneur.partnertracknumber || ''} ${entrepreneur.partnercomplementnumber || ''} ${entrepreneur.partnertracktype || ''} ${entrepreneur.partnerway || ''} ${entrepreneur.partneradditionaladdress || ''}`.trim(),
                    `${entrepreneur.partnerzipcode || ''} ${entrepreneur.partnercity || ''} ${formatCountry(entrepreneur.partnercountry) || ''}`.trim()
                ];
                const rows = [
                    createLine('Genre', capitalizeWords(entrepreneur.partnergender)),
                    createLine('Nom de naissance', (entrepreneur.partnerbirthname || '').toUpperCase())
                ];

                if (entrepreneur.partnername)
                    rows.push(createLine("Nom d'usage", (entrepreneur.partnername || '').toUpperCase()));

                rows.push(
                    createLine('Prénom', capitalizeWords(entrepreneur.partnerfirstname)),
                    createLine('Fonction', capitalizeWords(entrepreneur.partnerfonction)),
                );

                if (entrepreneur.partnerfonction != 'Aucun')
                {
                    rows.push(
                        createLine('Date de naissance', formatDateFR(entrepreneur.partnerbirthdate)),
                        createLine('Pays de naissance', formatCountry(entrepreneur.partnerbirthcountry)),
                        createLine('Nationalité', formatNationality(entrepreneur.partnernationality)),
                    )
                }
                if (!entrepreneur.partneraddress)
                    rows.push(createLine('Adresse', partnerAddress));
                else
                    rows.push(createLine('Adresse', addressParts));
                recapContainer.appendChild(createSection("Inormation partenaire", rows));
            }
        }

        // ---------------- BUSINESS ----------------
        if (Object.keys(business).length) {
            const businessAddress = `${business.tracknumber || ''} ${business.complementnumber || ''} ${business.tracktype || ''} ${business.way || ''}, ${business.zipcode || ''} ${business.city || ''}`;

            // INFORMATION DE L'ENTREPRISE
            let rows = [
                createLine('Micro-entreprise', business.micro),
            ];

            if (business.siren)
            {
                rows.push(createLine('SIREN', business.siren));
                rows.push(createLine('Fin activité antérieure', formatDateFR(business.oldactivitydate))),
                rows.push(createLine('Ancienne activité', business.oldactivity))
            }

            rows.push(
                createLine('Profession actuelle', business.otheractivity === 'Autre' ? business.otheractivitydetail || '-' : business.otheractivity),
                createLine('Déclaration URSSAF', business.insuranceorganization),
                createLine("Contrat d'appui", business.supportcontract),
                createLine("Demande d'ACCRE", business.accre),
            );
            recapContainer.appendChild(createSection("Information de l'entreprise", rows));

            // ACTIVITES DE L'ENTREPRISE
            rows = [
                createLine('Nom commercial', business.businessname),
                createLine('Forme activité', business.formofactivity),
                createLine('Activité principale', business.activity),
            ];

            if (business.way)
                rows.push(createLine('Adresse', businessAddress));
            else
                rows.push(createLine('Adresse', addressParts))
            if (business.domiciliationname)
                rows.push(createLine('Organisme de domiciliation', business.domiciliationname));
            if (business.domiciliationsiren)
                rows.push(createLine('Siren de domiciliation', business.domiciliationsiren));

            recapContainer.appendChild(createSection("Activités de l'entreprise", rows));

            // ACTIVITÉS SECONDAIRES
            const secondary = [];
            const n = parseInt(business.nbrofactivies || 0);
            for (let i = 0; i < n; i++) {
                const desc = business[`secondaryActivities[${i}][description]`];
                const form = business[`secondaryActivities[${i}][form]`];
                if (desc) secondary.push(`${desc} (${form})`);
            }

            if (secondary.length) {
                recapContainer.appendChild(
                    createSection("Activités secondaires", [
                        createLine('Liste', secondary)
                    ])
                );
            }
        }
    };
    displayRecap();
});
</script>
